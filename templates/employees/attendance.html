{% extends 'base.html' %}

{% block title %}Asistencia - {% if user.tenant %}{{ user.tenant.name }}{% else %}Gastro SaaS{% endif %}{% endblock %}
{% block mobile_title %}Asistencia{% endblock %}

{# active_page = "attendance" must be passed from the view context #}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6 max-w-7xl mx-auto">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
        <div>
            <h2 class="text-xl font-bold text-gray-900">Asistencia</h2>
            <p class="mt-0.5 text-sm text-gray-500">{{ today|date:"l d \d\e F \d\e Y" }}</p>
        </div>
        <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Registro del dia
            </span>
        </div>
    </div>

    {% if attendance_data %}

    <!-- Desktop table view -->
    <div class="bg-white rounded-xl border border-gray-200 hidden lg:block">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="border-b border-gray-200 bg-gray-50">
                        <th class="text-left py-3 px-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Empleado</th>
                        <th class="text-left py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Puesto</th>
                        <th class="text-center py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Entrada</th>
                        <th class="text-center py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Salida</th>
                        <th class="text-center py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Descanso</th>
                        <th class="text-center py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Hs</th>
                        <th class="text-center py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                        <th class="text-left py-3 px-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Notas</th>
                        <th class="text-center py-3 px-4 text-xs font-semibold text-gray-600 uppercase tracking-wider">Accion</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for item in attendance_data %}
                    <tr class="transition-colors
                        {% if item.worklog and item.worklog.status == 'working' %}bg-green-50/50 hover:bg-green-50
                        {% elif item.worklog and item.worklog.status == 'completed' %}bg-gray-50/50 hover:bg-gray-100/50
                        {% elif item.worklog and item.worklog.status == 'absent' %}bg-red-50/50 hover:bg-red-50
                        {% elif item.worklog and item.worklog.status == 'late' %}bg-yellow-50/50 hover:bg-yellow-50
                        {% else %}hover:bg-gray-50{% endif %}">
                        <form method="POST" action="{% url 'attendance_save' %}"
                              onsubmit="return validateFormFields(this, [{name:'clock_in', label:'Hora de entrada'}])">
                            {% csrf_token %}
                            <input type="hidden" name="employee_id" value="{{ item.employee.id }}">
                            <input type="hidden" name="date" value="{{ today|date:'Y-m-d' }}">

                            <!-- Employee name -->
                            <td class="py-2.5 px-4">
                                <div class="flex items-center gap-2.5">
                                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center
                                        {% if item.worklog and item.worklog.status == 'working' %}bg-green-100
                                        {% elif item.worklog and item.worklog.status == 'absent' %}bg-red-100
                                        {% elif item.worklog and item.worklog.status == 'late' %}bg-yellow-100
                                        {% else %}bg-purple-100{% endif %}">
                                        <span class="text-xs font-semibold
                                            {% if item.worklog and item.worklog.status == 'working' %}text-green-700
                                            {% elif item.worklog and item.worklog.status == 'absent' %}text-red-700
                                            {% elif item.worklog and item.worklog.status == 'late' %}text-yellow-700
                                            {% else %}text-purple-700{% endif %}">
                                            {{ item.employee.first_name|make_list|first|upper }}{{ item.employee.last_name|make_list|first|upper }}
                                        </span>
                                    </div>
                                    <span class="font-medium text-gray-900">{{ item.employee.full_name }}</span>
                                </div>
                            </td>

                            <!-- Position -->
                            <td class="py-2.5 px-3">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                    {% if item.employee.position == 'encargado' %}bg-indigo-100 text-indigo-700
                                    {% elif item.employee.position == 'cajero' %}bg-green-100 text-green-700
                                    {% elif item.employee.position == 'cocinero' %}bg-orange-100 text-orange-700
                                    {% elif item.employee.position == 'pizzero' %}bg-red-100 text-red-700
                                    {% elif item.employee.position == 'delivery' %}bg-blue-100 text-blue-700
                                    {% elif item.employee.position == 'mozo' %}bg-teal-100 text-teal-700
                                    {% elif item.employee.position == 'limpieza' %}bg-cyan-100 text-cyan-700
                                    {% elif item.employee.position == 'ayudante' %}bg-amber-100 text-amber-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ item.employee.get_position_display }}
                                </span>
                            </td>

                            <!-- Clock in -->
                            <td class="py-2.5 px-3 text-center">
                                <input type="time" name="clock_in"
                                       value="{% if item.worklog and item.worklog.clock_in %}{{ item.worklog.clock_in|time:'H:i' }}{% endif %}"
                                       class="w-24 px-2 py-1 text-xs text-center border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </td>

                            <!-- Clock out -->
                            <td class="py-2.5 px-3 text-center">
                                <input type="time" name="clock_out"
                                       value="{% if item.worklog and item.worklog.clock_out %}{{ item.worklog.clock_out|time:'H:i' }}{% endif %}"
                                       class="w-24 px-2 py-1 text-xs text-center border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </td>

                            <!-- Break minutes -->
                            <td class="py-2.5 px-3 text-center">
                                <input type="number" name="break_minutes"
                                       value="{% if item.worklog %}{{ item.worklog.break_minutes|default:'0' }}{% else %}0{% endif %}"
                                       min="0" step="5"
                                       class="w-16 px-2 py-1 text-xs text-center border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            </td>

                            <!-- Total hours (calculated, display only) -->
                            <td class="py-2.5 px-3 text-center">
                                {% if item.worklog and item.worklog.total_hours %}
                                <span class="text-sm font-semibold text-gray-900">{{ item.worklog.total_hours|floatformat:1 }}h</span>
                                {% else %}
                                <span class="text-xs text-gray-400">-</span>
                                {% endif %}
                            </td>

                            <!-- Status -->
                            <td class="py-2.5 px-3 text-center">
                                <select name="status"
                                        class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                                    <option value="">Sin registro</option>
                                    <option value="working" {% if item.worklog and item.worklog.status == 'working' %}selected{% endif %}>Trabajando</option>
                                    <option value="completed" {% if item.worklog and item.worklog.status == 'completed' %}selected{% endif %}>Completado</option>
                                    <option value="absent" {% if item.worklog and item.worklog.status == 'absent' %}selected{% endif %}>Ausente</option>
                                    <option value="late" {% if item.worklog and item.worklog.status == 'late' %}selected{% endif %}>Tarde</option>
                                    <option value="half_day" {% if item.worklog and item.worklog.status == 'half_day' %}selected{% endif %}>Medio dia</option>
                                </select>
                            </td>

                            <!-- Notes -->
                            <td class="py-2.5 px-3">
                                <input type="text" name="notes"
                                       value="{% if item.worklog %}{{ item.worklog.notes|default:'' }}{% endif %}"
                                       placeholder="Notas..."
                                       class="w-full px-2 py-1 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                       maxlength="200">
                            </td>

                            <!-- Save button -->
                            <td class="py-2.5 px-4 text-center">
                                <button type="submit"
                                        class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-sm"
                                        title="Guardar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </button>
                            </td>
                        </form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mobile card view -->
    <div class="space-y-3 lg:hidden">
        {% for item in attendance_data %}
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden
            {% if item.worklog and item.worklog.status == 'working' %}border-l-4 border-l-green-500
            {% elif item.worklog and item.worklog.status == 'completed' %}border-l-4 border-l-gray-400
            {% elif item.worklog and item.worklog.status == 'absent' %}border-l-4 border-l-red-500
            {% elif item.worklog and item.worklog.status == 'late' %}border-l-4 border-l-yellow-500
            {% endif %}">

            <form method="POST" action="{% url 'attendance_save' %}">
                {% csrf_token %}
                <input type="hidden" name="employee_id" value="{{ item.employee.id }}">
                <input type="hidden" name="date" value="{{ today|date:'Y-m-d' }}">

                <div class="p-4">
                    <!-- Employee header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2.5">
                            <div class="flex-shrink-0 w-9 h-9 rounded-full flex items-center justify-center
                                {% if item.worklog and item.worklog.status == 'working' %}bg-green-100
                                {% elif item.worklog and item.worklog.status == 'absent' %}bg-red-100
                                {% elif item.worklog and item.worklog.status == 'late' %}bg-yellow-100
                                {% else %}bg-purple-100{% endif %}">
                                <span class="text-xs font-bold
                                    {% if item.worklog and item.worklog.status == 'working' %}text-green-700
                                    {% elif item.worklog and item.worklog.status == 'absent' %}text-red-700
                                    {% elif item.worklog and item.worklog.status == 'late' %}text-yellow-700
                                    {% else %}text-purple-700{% endif %}">
                                    {{ item.employee.first_name|make_list|first|upper }}{{ item.employee.last_name|make_list|first|upper }}
                                </span>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-gray-900">{{ item.employee.full_name }}</h3>
                                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium
                                    {% if item.employee.position == 'encargado' %}bg-indigo-100 text-indigo-700
                                    {% elif item.employee.position == 'cajero' %}bg-green-100 text-green-700
                                    {% elif item.employee.position == 'cocinero' %}bg-orange-100 text-orange-700
                                    {% elif item.employee.position == 'pizzero' %}bg-red-100 text-red-700
                                    {% elif item.employee.position == 'delivery' %}bg-blue-100 text-blue-700
                                    {% elif item.employee.position == 'mozo' %}bg-teal-100 text-teal-700
                                    {% elif item.employee.position == 'limpieza' %}bg-cyan-100 text-cyan-700
                                    {% elif item.employee.position == 'ayudante' %}bg-amber-100 text-amber-700
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ item.employee.get_position_display }}
                                </span>
                            </div>
                        </div>
                        {% if item.worklog and item.worklog.total_hours %}
                        <span class="text-lg font-bold text-gray-900">{{ item.worklog.total_hours|floatformat:1 }}h</span>
                        {% endif %}
                    </div>

                    <!-- Time inputs grid -->
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-0.5">Entrada</label>
                            <input type="time" name="clock_in"
                                   value="{% if item.worklog and item.worklog.clock_in %}{{ item.worklog.clock_in|time:'H:i' }}{% endif %}"
                                   class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-0.5">Salida</label>
                            <input type="time" name="clock_out"
                                   value="{% if item.worklog and item.worklog.clock_out %}{{ item.worklog.clock_out|time:'H:i' }}{% endif %}"
                                   class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-0.5">Desc (min)</label>
                            <input type="number" name="break_minutes"
                                   value="{% if item.worklog %}{{ item.worklog.break_minutes|default:'0' }}{% else %}0{% endif %}"
                                   min="0" step="5"
                                   class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        </div>
                    </div>

                    <!-- Status and notes -->
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-0.5">Estado</label>
                            <select name="status"
                                    class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                                <option value="">Sin registro</option>
                                <option value="working" {% if item.worklog and item.worklog.status == 'working' %}selected{% endif %}>Trabajando</option>
                                <option value="completed" {% if item.worklog and item.worklog.status == 'completed' %}selected{% endif %}>Completado</option>
                                <option value="absent" {% if item.worklog and item.worklog.status == 'absent' %}selected{% endif %}>Ausente</option>
                                <option value="late" {% if item.worklog and item.worklog.status == 'late' %}selected{% endif %}>Tarde</option>
                                <option value="half_day" {% if item.worklog and item.worklog.status == 'half_day' %}selected{% endif %}>Medio dia</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-0.5">Notas</label>
                            <input type="text" name="notes"
                                   value="{% if item.worklog %}{{ item.worklog.notes|default:'' }}{% endif %}"
                                   placeholder="Notas..."
                                   class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                   maxlength="200">
                        </div>
                    </div>

                    <!-- Save button -->
                    <button type="submit"
                            class="w-full inline-flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                        Guardar
                    </button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>

    <!-- Summary footer -->
    <div class="mt-6 bg-white rounded-xl border border-gray-200 p-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Resumen del dia</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <!-- Total employees -->
            <div class="text-center p-3 rounded-lg bg-gray-50">
                <p class="text-2xl font-bold text-gray-900" id="total-employees">{{ attendance_data|length }}</p>
                <p class="text-xs text-gray-500 mt-0.5">Total empleados</p>
            </div>

            <!-- Present -->
            <div class="text-center p-3 rounded-lg bg-green-50">
                <p class="text-2xl font-bold text-green-700" id="total-present">
                    {% with present_count=0 %}
                    {% for item in attendance_data %}
                        {% if item.worklog and item.worklog.status == 'working' or item.worklog and item.worklog.status == 'completed' or item.worklog and item.worklog.status == 'late' or item.worklog and item.worklog.status == 'half_day' %}
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                    <span data-summary="present"></span>
                </p>
                <p class="text-xs text-green-600 mt-0.5">Presentes</p>
            </div>

            <!-- Absent -->
            <div class="text-center p-3 rounded-lg bg-red-50">
                <p class="text-2xl font-bold text-red-700" id="total-absent">
                    <span data-summary="absent"></span>
                </p>
                <p class="text-xs text-red-600 mt-0.5">Ausentes</p>
            </div>

            <!-- Without record -->
            <div class="text-center p-3 rounded-lg bg-yellow-50">
                <p class="text-2xl font-bold text-yellow-700" id="total-no-record">
                    <span data-summary="no-record"></span>
                </p>
                <p class="text-xs text-yellow-600 mt-0.5">Sin registro</p>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Empty state -->
    <div class="bg-white rounded-xl border border-gray-200 py-16 text-center">
        <svg class="mx-auto w-12 h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <h3 class="mt-4 text-sm font-semibold text-gray-900">Sin empleados activos</h3>
        <p class="mt-1 text-sm text-gray-500">Necesitas empleados activos para registrar asistencia.</p>
        <a href="{% url 'employee_create' %}"
           class="inline-flex items-center gap-2 mt-5 px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
            Agregar Empleado
        </a>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Calculate and display attendance summary counts
    document.addEventListener('DOMContentLoaded', function() {
        var statusSelects = document.querySelectorAll('select[name="status"]');
        var totalEmployees = statusSelects.length;

        function updateSummary() {
            var present = 0;
            var absent = 0;
            var noRecord = 0;

            statusSelects.forEach(function(select) {
                var val = select.value;
                if (val === 'working' || val === 'completed' || val === 'late' || val === 'half_day') {
                    present++;
                } else if (val === 'absent') {
                    absent++;
                } else {
                    noRecord++;
                }
            });

            var presentEl = document.querySelector('[data-summary="present"]');
            var absentEl = document.querySelector('[data-summary="absent"]');
            var noRecordEl = document.querySelector('[data-summary="no-record"]');

            if (presentEl) presentEl.textContent = present;
            if (absentEl) absentEl.textContent = absent;
            if (noRecordEl) noRecordEl.textContent = noRecord;
        }

        // Update on page load
        updateSummary();

        // Update when any status select changes
        statusSelects.forEach(function(select) {
            select.addEventListener('change', updateSummary);
        });
    });
</script>
{% endblock %}